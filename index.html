<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FinBuddy - Financial Dashboard</title>
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>


    <!-- Lucide Icons CDN -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.min.js"></script>

    <!-- Supabase JS Client CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <!-- Google Fonts: Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* Custom styles to apply the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Animation for modals */
        .modal-enter {
            animation: fadeIn 0.3s ease-out forwards;
        }
        .modal-leave {
            animation: fadeOut 0.3s ease-in forwards;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); }
            to { opacity: 0; transform: scale(0.95); }
        }
        /* Styles for collapsible sidebar */
        body.sidebar-collapsed aside {
            width: 5rem; /* w-20 */
        }
        body.sidebar-collapsed .nav-text,
        body.sidebar-collapsed #sidebar-title,
        body.sidebar-collapsed #sidebar-footer,
        body.sidebar-collapsed .toggle-icon-collapse {
            display: none;
        }
        body.sidebar-collapsed .toggle-icon-expand {
            display: block;
        }
        body.sidebar-collapsed aside nav a {
            justify-content: center;
        }
        .toggle-icon-expand {
            display: none;
        }
    </style>
     <script>
        // Set theme on initial load to prevent flash of unstyled content
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark')
        } else {
            document.documentElement.classList.remove('dark')
        }
    </script>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200">

    <div class="flex h-screen">
        <!-- =================================================================
            LEFT NAVIGATION SIDEBAR
        ================================================================== -->
        <aside class="w-64 flex-shrink-0 bg-gray-800 dark:bg-gray-900 text-gray-300 flex flex-col p-4 border-r border-gray-200 dark:border-gray-700 transition-all duration-300">
            <div class="flex items-center space-x-2 mb-10 px-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-teal-400 flex-shrink-0"><path d="M3 3v18h18"></path><path d="m19 9-5 5-4-4-3 3"></path></svg>
                <h1 id="sidebar-title" class="text-2xl font-bold text-white">FinBuddy</h1>
            </div>
            
            <nav class="flex-1" id="main-nav">
                <ul class="space-y-2">
                    <li>
                        <a href="#" data-page="overview" class="nav-link flex items-center space-x-3 px-3 py-2.5 rounded-lg bg-gray-700 text-white">
                            <i data-lucide="layout-dashboard"></i>
                            <span class="nav-text">Overview</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="budgets" class="nav-link flex items-center space-x-3 px-3 py-2.5 rounded-lg hover:bg-gray-700 transition-colors duration-200">
                            <i data-lucide="piggy-bank"></i>
                            <span class="nav-text">Budgets</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="expenses" class="nav-link flex items-center space-x-3 px-3 py-2.5 rounded-lg hover:bg-gray-700 transition-colors duration-200">
                            <i data-lucide="receipt"></i>
                            <span class="nav-text">Expenses</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="income" class="nav-link flex items-center space-x-3 px-3 py-2.5 rounded-lg hover:bg-gray-700 transition-colors duration-200">
                             <i data-lucide="dollar-sign"></i>
                            <span class="nav-text">Income</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="reports" class="nav-link flex items-center space-x-3 px-3 py-2.5 rounded-lg hover:bg-gray-700 transition-colors duration-200">
                            <i data-lucide="bar-chart-3"></i>
                            <span class="nav-text">Reports</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-page="settings" class="nav-link flex items-center space-x-3 px-3 py-2.5 rounded-lg hover:bg-gray-700 transition-colors duration-200">
                            <i data-lucide="settings"></i>
                            <span class="nav-text">Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>
            
            <div id="sidebar-footer">
                <div class="bg-gray-700/50 dark:bg-gray-800 rounded-lg p-4 text-center">
                    <p class="text-sm text-gray-200">Have a question?</p>
                    <p class="text-xs text-gray-400 mt-1">Reach out to gundu via phone or email.</p>
                    <div class="mt-4 flex space-x-2">
                         <a href="tel:+918123084877" class="flex-1 flex items-center justify-center space-x-2 bg-gray-600 hover:bg-gray-500 text-white text-sm py-2 rounded-lg transition-colors duration-200">
                             <i data-lucide="phone" class="w-4 h-4"></i>
                             <span>Call</span>
                         </a>
                         <a href="mailto:manishreddynakkala@gmail.com" class="flex-1 flex items-center justify-center space-x-2 bg-teal-500 hover:bg-teal-600 text-white text-sm py-2 rounded-lg transition-colors duration-200">
                             <i data-lucide="mail" class="w-4 h-4"></i>
                             <span>Email</span>
                         </a>
                    </div>
                </div>

                <a href="#" class="flex items-center space-x-3 px-3 py-4 mt-2 rounded-lg text-pink-400 hover:bg-gray-700 transition-colors duration-200">
                    <i data-lucide="heart"></i>
                    <span class="nav-text">With love</span>
                </a>
            </div>
            
            <div class="border-t border-gray-700 mt-auto pt-2">
                <button id="sidebar-toggle" class="w-full flex items-center justify-center p-3 text-gray-400 hover:bg-gray-700 hover:text-white rounded-lg">
                    <i data-lucide="chevrons-left" class="toggle-icon-collapse"></i>
                    <i data-lucide="chevrons-right" class="toggle-icon-expand"></i>
                </button>
            </div>
        </aside>

        <!-- =================================================================
            MAIN CONTENT AREA
        ================================================================== -->
        <main class="flex-1 p-8 overflow-y-auto bg-gray-50 dark:bg-gray-800/50 transition-all duration-300">
            
            <!-- OVERVIEW PAGE -->
            <div id="overview-page" class="page-content">
                <div class="flex justify-between items-start mb-8">
                    <header>
                        <h1 id="welcome-message" class="text-3xl font-bold text-gray-900 dark:text-white">Welcome back, Saranya</h1>
                        <p class="text-gray-500 dark:text-gray-400 mt-1">Here's an overview of all of your balances.</p>
                    </header>
                    <img src="https://placehold.co/40x40/C4B5FD/6D28D9?text=S" alt="Saranya's Profile" class="w-10 h-10 rounded-full">
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2">
                        <!-- Account Balance Card -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="font-semibold text-lg text-gray-900 dark:text-white">Account Balance</h2>
                                <div id="chart-filters" class="flex space-x-1 bg-gray-100 dark:bg-gray-700 p-1 rounded-lg">
                                    <button data-period="day" class="chart-filter-btn px-3 py-1 text-sm rounded-md hover:bg-white dark:hover:bg-gray-600 transition-colors text-gray-600 dark:text-gray-300">Day</button>
                                    <button data-period="week" class="chart-filter-btn px-3 py-1 text-sm rounded-md hover:bg-white dark:hover:bg-gray-600 transition-colors text-gray-600 dark:text-gray-300">Week</button>
                                    <button data-period="month" class="chart-filter-btn px-3 py-1 text-sm rounded-md hover:bg-white dark:hover:bg-gray-600 transition-colors text-gray-600 dark:text-gray-300">Month</button>
                                    <button data-period="year" class="chart-filter-btn px-3 py-1 text-sm rounded-md bg-white dark:bg-gray-500 text-gray-800 dark:text-white font-medium shadow-sm transition-colors active">Year</button>
                                </div>
                            </div>
                            <div class="h-72">
                                <canvas id="accountBalanceChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Recent Transactions Card -->
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm mt-8">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="font-semibold text-lg text-gray-900 dark:text-white">Recent Transactions</h2>
                                <a href="#" id="see-all-transactions" class="text-teal-500 font-semibold text-sm hover:text-teal-600">See all</a>
                            </div>
                            <div id="transactions-list" class="space-y-4">
                                <!-- Transactions will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1">
                        <div class="space-y-6">
                           <!-- Total Balance Card -->
                            <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm relative">
                               <div class="flex justify-between items-center">
                                    <div class="flex items-center space-x-3">
                                        <div class="p-2 bg-teal-100 dark:bg-teal-900/50 rounded-full">
                                            <i data-lucide="wallet" class="text-teal-500 dark:text-teal-400"></i>
                                        </div>
                                        <span class="font-semibold text-gray-900 dark:text-white">Total Balance</span>
                                    </div>
                                    <button data-account="total" class="account-menu-btn text-gray-400 hover:text-gray-600"><i data-lucide="more-horizontal" class="w-5 h-5 pointer-events-none"></i></button>
                                    <div data-dropdown="total" class="account-dropdown absolute top-10 right-4 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-xl w-40 hidden z-10">
                                        <ul>
                                            <li>
                                                <button data-account="total" class="update-account-btn w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center space-x-2">
                                                    <i data-lucide="edit-3" class="w-4 h-4"></i>
                                                    <span>Update Balance</span>
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                               </div>
                               <p id="total-balance-amount" class="text-3xl font-bold mt-4 text-gray-900 dark:text-white"></p>
                            </div>
                            
                            <!-- Main Account Card -->
                            <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm relative">
                               <div class="flex justify-between items-center">
                                    <div class="flex items-center space-x-3">
                                        <div class="p-2 bg-blue-100 dark:bg-blue-900/50 rounded-full">
                                            <i data-lucide="landmark" class="text-blue-500 dark:text-blue-400"></i>
                                        </div>
                                        <span class="font-semibold text-gray-900 dark:text-white">Main Account</span>
                                    </div>
                                    <button data-account="main" class="account-menu-btn text-gray-400 hover:text-gray-600"><i data-lucide="more-horizontal" class="w-5 h-5 pointer-events-none"></i></button>
                                    <div data-dropdown="main" class="account-dropdown absolute top-10 right-4 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-xl w-40 hidden z-10">
                                        <ul>
                                            <li>
                                                <button data-account="main" class="update-account-btn w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center space-x-2">
                                                    <i data-lucide="edit-3" class="w-4 h-4"></i>
                                                    <span>Update Balance</span>
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                               </div>
                               <p id="main-account-balance" class="text-2xl font-bold mt-4 text-gray-900 dark:text-white"></p>
                            </div>
                            
                            <!-- Savings Card -->
                            <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm relative">
                               <div class="flex justify-between items-center">
                                    <div class="flex items-center space-x-3">
                                        <div class="p-2 bg-indigo-100 dark:bg-indigo-900/50 rounded-full">
                                            <i data-lucide="circle-dollar-sign" class="text-indigo-500 dark:text-indigo-400"></i>
                                        </div>
                                        <span class="font-semibold text-gray-900 dark:text-white">Savings</span>
                                    </div>
                                   <button data-account="savings" class="account-menu-btn text-gray-400 hover:text-gray-600"><i data-lucide="more-horizontal" class="w-5 h-5 pointer-events-none"></i></button>
                                   <div data-dropdown="savings" class="account-dropdown absolute top-10 right-4 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg shadow-xl w-40 hidden z-10">
                                        <ul>
                                            <li>
                                                <button data-account="savings" class="update-account-btn w-full text-left px-4 py-2 text-sm text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-600 flex items-center space-x-2">
                                                    <i data-lucide="edit-3" class="w-4 h-4"></i>
                                                    <span>Update Balance</span>
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                               </div>
                               <p id="savings-balance" class="text-2xl font-bold mt-4 text-gray-900 dark:text-white"></p>
                            </div>
                             <!-- Income Card -->
                            <div class="bg-white dark:bg-gray-800 p-5 rounded-xl shadow-sm">
                               <div class="flex justify-between items-center">
                                    <div class="flex items-center space-x-3">
                                        <div class="p-2 bg-green-100 dark:bg-green-900/50 rounded-full">
                                            <i data-lucide="dollar-sign" class="text-green-500 dark:text-green-400"></i>
                                        </div>
                                        <span class="font-semibold text-gray-900 dark:text-white">Income</span>
                                    </div>
                                   <button class="text-gray-400 hover:text-gray-600"><i data-lucide="more-horizontal" class="w-5 h-5"></i></button>
                               </div>
                               <p id="income-balance" class="text-2xl font-bold mt-4 text-gray-900 dark:text-white"></p>
                               <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">This Month</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BUDGETS PAGE -->
            <div id="budgets-page" class="page-content hidden">
                 <header class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Budgets</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-1">Manage your monthly spending and savings goals.</p>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left Column: Budget Categories -->
                    <div class="lg:col-span-2 space-y-8">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="font-semibold text-lg text-gray-900 dark:text-white">Budget Categories</h2>
                                <button id="add-category-btn" class="bg-teal-500 text-white px-4 py-2 text-sm font-semibold rounded-lg hover:bg-teal-600 transition-colors flex items-center space-x-2">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    <span>Add New Category</span>
                                </button>
                            </div>
                            <div id="budget-categories-list" class="space-y-5">
                                <!-- Budget categories will be dynamically inserted here -->
                            </div>
                        </div>
                        
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                             <div class="flex justify-between items-center mb-4">
                                <h2 class="font-semibold text-lg text-gray-900 dark:text-white">Recurring Bills & Subscriptions</h2>
                                <button id="add-bill-btn" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-4 py-2 text-sm font-semibold rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors flex items-center space-x-2">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                    <span>Add Recurring Bill</span>
                                </button>
                            </div>
                            <div id="recurring-bills-list" class="space-y-3">
                                <!-- Recurring bills will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column: Savings Goals -->
                    <div class="lg:col-span-1">
                         <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="font-semibold text-lg text-gray-900 dark:text-white">Savings Goals</h2>
                                <button id="add-goal-btn" class="text-teal-500 font-semibold text-sm hover:text-teal-600">
                                    Add New Goal
                                </button>
                            </div>
                            <div id="savings-goals-list" class="space-y-6">
                               <!-- Savings goals will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- EXPENSES PAGE -->
            <div id="expenses-page" class="page-content hidden">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Expenses</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-1">Track, filter, and manage all your spending.</p>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Left Column: Expense History & Filters -->
                    <div class="lg:col-span-2">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                            <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                                <h2 class="font-semibold text-lg text-gray-900 dark:text-white">Expense History</h2>
                                <div class="flex items-center gap-2 w-full md:w-auto">
                                    <input type="text" id="expense-search-input" placeholder="Search by keyword..." class="w-full md:w-40 px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 text-sm">
                                    <select id="expense-category-filter" class="px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 text-sm">
                                        <option value="all">All Categories</option>
                                    </select>
                                    <input type="date" id="expense-date-filter" class="px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 text-sm">
                                </div>
                            </div>
                            <div id="expense-history-list" class="space-y-2">
                                <!-- Expense items will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                    <!-- Right Column: Add Expense & Summary -->
                    <div class="lg:col-span-1 space-y-8">
                         <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                            <h2 class="font-semibold text-lg mb-4 text-gray-900 dark:text-white">Add New Expense</h2>
                            <form id="add-expense-form" class="space-y-4">
                                <div>
                                    <label for="expense-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (₹)</label>
                                    <input type="number" id="expense-amount" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                                </div>
                                <div>
                                    <label for="expense-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
                                    <input type="date" id="expense-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                                </div>
                                <div>
                                    <label for="expense-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                                    <select id="expense-category" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                                        <!-- Populated from budgets -->
                                    </select>
                                </div>
                                <div>
                                    <label for="expense-source" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment From</label>
                                    <select id="expense-source" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                                        <option value="">Select Account</option>
                                        <option value="main">Main Account</option>
                                        <option value="savings">Savings</option>
                                    </select>
                                </div>
                                 <div>
                                    <label for="expense-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Notes (Optional)</label>
                                    <textarea id="expense-notes" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500"></textarea>
                                </div>
                                <button type="submit" class="w-full bg-teal-500 text-white px-4 py-2.5 text-sm font-semibold rounded-lg hover:bg-teal-600 transition-colors flex items-center justify-center space-x-2">
                                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                                    <span>Add Expense</span>
                                </button>
                            </form>
                        </div>
                         <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                            <h2 class="font-semibold text-lg mb-4 text-gray-900 dark:text-white">Spending Summary</h2>
                            <div class="h-48 w-48 mx-auto mb-4">
                                <canvas id="spending-pie-chart"></canvas>
                            </div>
                            <div class="text-center">
                                <p class="text-gray-500 dark:text-gray-400 text-sm">Total Spent This Month</p>
                                <p id="total-spent-month" class="text-2xl font-bold text-gray-900 dark:text-white"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- INCOME PAGE -->
            <div id="income-page" class="page-content hidden">
                <header class="mb-8 flex justify-between items-center">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Income</h1>
                        <p class="text-gray-500 dark:text-gray-400 mt-1">Track and manage your income.</p>
                    </div>
                    <button id="manage-sources-btn" class="bg-gray-200 dark:bg-gray-700 text-gray-800 dark:text-gray-200 px-4 py-2 text-sm font-semibold rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors flex items-center space-x-2">
                        <i data-lucide="settings-2" class="w-4 h-4"></i>
                        <span>Manage Sources</span>
                    </button>
                </header>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                      <!-- Left Column: Income History -->
                    <div class="lg:col-span-2">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                            <h2 class="font-semibold text-lg mb-4 text-gray-900 dark:text-white">Income History</h2>
                            <div id="income-history-list" class="space-y-2">
                                <!-- Income items will be dynamically inserted here -->
                            </div>
                        </div>
                    </div>
                      <!-- Right Column: Add Income & Summary -->
                    <div class="lg:col-span-1 space-y-8">
                         <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                            <h2 class="font-semibold text-lg mb-4 text-gray-900 dark:text-white">Add New Income</h2>
                            <form id="add-income-form" class="space-y-4">
                                <div>
                                    <label for="income-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (₹)</label>
                                    <input type="number" id="income-amount" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                </div>
                                <div>
                                    <label for="income-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date Received</label>
                                    <input type="date" id="income-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                </div>
                                <div>
                                    <label for="income-source" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Source</label>
                                    <select id="income-source" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                       <!-- Populated from sources -->
                                    </select>
                                </div>
                                <div>
                                    <label for="income-account" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Deposit To</label>
                                    <select id="income-account" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                                        <option value="">Select Account</option>
                                        <option value="main">Main Account</option>
                                        <option value="savings">Savings</option>
                                    </select>
                                </div>
                                 <div>
                                    <label for="income-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Notes (Optional)</label>
                                    <textarea id="income-notes" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></textarea>
                                </div>
                                <button type="submit" class="w-full bg-green-500 text-white px-4 py-2.5 text-sm font-semibold rounded-lg hover:bg-green-600 transition-colors flex items-center justify-center space-x-2">
                                    <i data-lucide="plus-circle" class="w-4 h-4"></i>
                                    <span>Add Income</span>
                                </button>
                            </form>
                        </div>
                         <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                            <h2 class="font-semibold text-lg mb-4 text-gray-900 dark:text-white">Income Summary</h2>
                            <div class="h-48 w-48 mx-auto mb-4">
                                <canvas id="income-pie-chart"></canvas>
                            </div>
                            <div class="text-center">
                                <p class="text-gray-500 dark:text-gray-400 text-sm">Total Income This Month</p>
                                <p id="total-income-month" class="text-2xl font-bold text-gray-900 dark:text-white"></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- REPORTS PAGE -->
            <div id="reports-page" class="page-content hidden">
                 <header class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Reports</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-1">Analyze your financial habits over time.</p>
                </header>

                <div class="space-y-8">
                    <!-- Spending by Category -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                            <h2 class="text-xl font-semibold mb-2 md:mb-0 text-gray-900 dark:text-white">Spending by Category</h2>
                            <select id="spending-category-date-filter" class="px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 text-sm">
                                <option value="this-month">This Month</option>
                                <option value="last-month">Last Month</option>
                                <option value="this-year">This Year</option>
                            </select>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-6 items-center">
                            <div class="md:col-span-2 h-64">
                                <canvas id="spendingByCategoryChart"></canvas>
                            </div>
                            <div id="category-transaction-list" class="md:col-span-3 max-h-64 overflow-y-auto">
                                <p class="text-center text-gray-500 dark:text-gray-400">Click on a category in the chart to see transactions.</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Income vs Expense -->
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                        <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Income vs. Expense (Last 6 Months)</h2>
                        <div class="h-80">
                            <canvas id="incomeVsExpenseChart"></canvas>
                        </div>
                    </div>

                    <!-- Trend Reports -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                             <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Total Spending Over Time</h2>
                             <div class="h-80">
                                 <canvas id="totalSpendingTrendChart"></canvas>
                             </div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm">
                             <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold text-gray-900 dark:text-white">Category Spending Trend</h2>
                                <select id="category-trend-filter" class="px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500 text-sm">
                                     <!-- Populated dynamically -->
                                </select>
                             </div>
                             <div class="h-80">
                                 <canvas id="categorySpendingTrendChart"></canvas>
                             </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- SETTINGS PAGE -->
            <div id="settings-page" class="page-content hidden">
                <header class="mb-8">
                    <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Settings</h1>
                    <p class="text-gray-500 dark:text-gray-400 mt-1">Manage your application preferences.</p>
                </header>

                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl shadow-sm max-w-2xl">
                    <h2 class="text-xl font-semibold mb-4 text-gray-900 dark:text-white">Appearance</h2>
                    <div class="flex items-center justify-between">
                         <p class="text-gray-600 dark:text-gray-300">Theme</p>
                        <div class="flex items-center space-x-2 bg-gray-100 dark:bg-gray-700 rounded-full p-1">
                            <button id="theme-light-btn" class="theme-btn flex items-center space-x-2 px-4 py-1.5 text-sm font-medium rounded-full">
                                <i data-lucide="sun" class="w-4 h-4"></i>
                                <span>Light</span>
                            </button>
                             <button id="theme-dark-btn" class="theme-btn flex items-center space-x-2 px-4 py-1.5 text-sm font-medium rounded-full">
                                 <i data-lucide="moon" class="w-4 h-4"></i>
                                <span>Dark</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>


        </main>
    </div>
    
    <!-- MODALS -->
    <!-- Add Category Modal -->
    <div id="add-category-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md modal-enter">
            <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Add New Budget Category</h2>
            <form id="add-category-form">
                <div class="space-y-4">
                    <div>
                        <label for="category-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category Name</label>
                        <input type="text" id="category-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="category-limit" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Monthly Spending Limit (₹)</label>
                        <input type="number" id="category-limit" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" class="modal-close-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 dark:bg-gray-600 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-500">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-teal-500 rounded-lg hover:bg-teal-600">Add Category</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Category Modal -->
    <div id="edit-category-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md modal-enter">
            <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Edit Budget Category</h2>
            <form id="edit-category-form">
                <input type="hidden" id="edit-category-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-category-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category Name</label>
                        <input type="text" id="edit-category-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="edit-category-limit" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Monthly Spending Limit (₹)</label>
                        <input type="number" id="edit-category-limit" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" class="modal-close-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 dark:bg-gray-600 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-500">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-teal-500 rounded-lg hover:bg-teal-600">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Add Bill Modal -->
    <div id="add-bill-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
       <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md modal-enter">
            <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Add Recurring Bill</h2>
            <form id="add-bill-form">
                <div class="space-y-4">
                    <div>
                        <label for="bill-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Bill Name</label>
                        <input type="text" id="bill-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="bill-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (₹)</label>
                        <input type="number" id="bill-amount" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="bill-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Budget Category</label>
                        <select id="bill-category" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                            <!-- Options will be populated dynamically -->
                        </select>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" class="modal-close-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 dark:bg-gray-600 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-500">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-teal-500 rounded-lg hover:bg-teal-600">Add Bill</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Add Goal Modal -->
     <div id="add-goal-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
       <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md modal-enter">
            <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Add New Savings Goal</h2>
            <form id="add-goal-form">
                <div class="space-y-4">
                    <div>
                        <label for="goal-name" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Goal Name</label>
                        <input type="text" id="goal-name" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="goal-target" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Target Amount (₹)</label>
                        <input type="number" id="goal-target" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" class="modal-close-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 dark:bg-gray-600 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-500">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-teal-500 rounded-lg hover:bg-teal-600">Add Goal</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Update Account Balance Modal -->
    <div id="update-account-balance-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
       <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md modal-enter">
            <h2 id="update-account-modal-title" class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Update Balance</h2>
            <form id="update-account-balance-form">
                <div class="space-y-4">
                    <div>
                        <label for="new-account-balance" class="block text-sm font-medium text-gray-700 dark:text-gray-300">New Balance Amount (₹)</label>
                        <input type="number" id="new-account-balance" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500" placeholder="e.g., 950000">
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" class="modal-close-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 dark:bg-gray-600 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-500">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-teal-500 rounded-lg hover:bg-teal-600">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Edit Expense Modal -->
    <div id="edit-expense-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
       <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md modal-enter">
            <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Edit Expense</h2>
            <form id="edit-expense-form">
                <input type="hidden" id="edit-expense-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-expense-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (₹)</label>
                        <input type="number" id="edit-expense-amount" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="edit-expense-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date</label>
                        <input type="date" id="edit-expense-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                    </div>
                    <div>
                        <label for="edit-expense-category" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Category</label>
                        <select id="edit-expense-category" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                            <!-- Populated from budgets -->
                        </select>
                    </div>
                    <div>
                        <label for="edit-expense-source" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Payment From</label>
                        <select id="edit-expense-source" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500">
                            <option value="main">Main Account</option>
                            <option value="savings">Savings</option>
                        </select>
                    </div>
                     <div>
                        <label for="edit-expense-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Notes (Optional)</label>
                        <textarea id="edit-expense-notes" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-teal-500 focus:border-teal-500"></textarea>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" class="modal-close-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 dark:bg-gray-600 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-500">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-teal-500 rounded-lg hover:bg-teal-600">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Income Modal -->
    <div id="edit-income-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md modal-enter">
            <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Edit Income</h2>
            <form id="edit-income-form">
                <input type="hidden" id="edit-income-id">
                <div class="space-y-4">
                    <div>
                        <label for="edit-income-amount" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Amount (₹)</label>
                        <input type="number" id="edit-income-amount" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="edit-income-date" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Date Received</label>
                        <input type="date" id="edit-income-date" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    </div>
                    <div>
                        <label for="edit-income-source" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Source</label>
                        <select id="edit-income-source" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                           <!-- Populated from sources -->
                        </select>
                    </div>
                    <div>
                        <label for="edit-income-account" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Deposit To</label>
                        <select id="edit-income-account" required class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                            <option value="main">Main Account</option>
                            <option value="savings">Savings</option>
                        </select>
                    </div>
                     <div>
                        <label for="edit-income-notes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Notes (Optional)</label>
                        <textarea id="edit-income-notes" rows="2" class="mt-1 block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500"></textarea>
                    </div>
                </div>
                <div class="mt-8 flex justify-end space-x-3">
                    <button type="button" class="modal-close-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 dark:bg-gray-600 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-500">Cancel</button>
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-green-500 rounded-lg hover:bg-green-600">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Manage Income Sources Modal -->
    <div id="manage-sources-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white dark:bg-gray-800 p-8 rounded-xl shadow-2xl w-full max-w-md modal-enter">
            <h2 class="text-2xl font-bold mb-6 text-gray-900 dark:text-white">Manage Income Sources</h2>
            <div class="mb-6">
                <h3 class="text-lg font-semibold mb-2 text-gray-900 dark:text-white">Add New Source</h3>
                <form id="add-source-form" class="flex gap-2">
                    <input type="text" id="new-source-name" placeholder="e.g., Salary, Freelance" required class="flex-grow block w-full px-3 py-2 border border-gray-300 dark:border-gray-600 bg-white dark:bg-gray-700 rounded-md shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500">
                    <button type="submit" class="px-4 py-2 text-sm font-medium text-white bg-green-500 rounded-lg hover:bg-green-600">Add</button>
                </form>
            </div>
            <div>
                 <h3 class="text-lg font-semibold mb-2 text-gray-900 dark:text-white">Existing Sources</h3>
                 <div id="income-sources-list" class="space-y-2 max-h-60 overflow-y-auto">
                     <!-- Source items will be dynamically inserted here -->
                 </div>
            </div>
             <div class="mt-8 flex justify-end">
                <button type="button" class="modal-close-btn px-4 py-2 text-sm font-medium text-gray-700 bg-gray-100 dark:bg-gray-600 dark:text-gray-200 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-500">Close</button>
            </div>
        </div>
    </div>


    <script>
        document.addEventListener('DOMContentLoaded', async function () {
            // --- SUPABASE INITIALIZATION ---
            const SUPABASE_URL = 'https://xnhwiaebbaenxarnobtu.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhuaHdpYWViYmFlbnhhcm5vYnR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTg1NTUxMjUsImV4cCI6MjA3NDEzMTEyNX0.ytMwIF56KMxpdHbbQSo0nEkRR8AEUnUWRyJPGkYP530';

            const { createClient } = supabase;
            const db = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            lucide.createIcons();
            
            // --- ELEMENT SELECTORS ---
            const totalBalanceAmountEl = document.getElementById('total-balance-amount');
            const mainAccountBalanceEl = document.getElementById('main-account-balance');
            const savingsBalanceEl = document.getElementById('savings-balance');
            const incomeBalanceEl = document.getElementById('income-balance');
            
            // --- STATE MANAGEMENT ---
            let state = {
                accounts: [],
                budgetCategories: [],
                recurringBills: [],
                savingsGoals: [],
                expenses: [],
                income: [],
                incomeSources: [],
                get totalBalance() {
                    return this.accounts.reduce((sum, acc) => sum + parseFloat(acc.balance), 0);
                },
                 get mainAccountBalance() {
                    const main = this.accounts.find(a => a.account_name === 'Main Account');
                    return main ? parseFloat(main.balance) : 0;
                },
                get savingsBalance() {
                    const savings = this.accounts.find(a => a.account_name === 'Savings');
                    return savings ? parseFloat(savings.balance) : 0;
                },
                get totalIncomeThisMonth() {
                    const currentMonth = new Date().getMonth();
                    const currentYear = new Date().getFullYear();
                    return this.income
                        .filter(inc => {
                            const incDate = new Date(inc.date);
                            return incDate.getMonth() === currentMonth && incDate.getFullYear() === currentYear;
                        })
                        .reduce((sum, inc) => sum + inc.amount, 0);
                }
            };
            
            const formatCurrency = (amount) => {
                return amount.toLocaleString('en-IN', { style: 'currency', currency: 'INR', minimumFractionDigits: 0, maximumFractionDigits: 0 });
            }

              // --- DATA LOADING ---
            async function loadInitialData() {
                const { data: accounts, error: accError } = await db.from('accounts').select('*');
                if (accError) console.error("Error fetching accounts:", accError);
                else state.accounts = accounts;

                const { data: categories, error: catError } = await db.from('budget_categories').select('*');
                if (catError) console.error("Error fetching categories:", catError);
                else state.budgetCategories = categories;

                const { data: bills, error: billError } = await db.from('recurring_bills').select('*, budget_categories(name)');
                if (billError) {
                    console.error("Error fetching bills:", billError);
                } else {
                     state.recurringBills = bills.map(b => ({
                        id: b.id,
                        name: b.name,
                        amount: b.amount,
                        category: b.budget_categories ? b.budget_categories.name : 'Uncategorized'
                    }));
                }

                const { data: goals, error: goalError } = await db.from('savings_goals').select('*');
                 if (goalError) console.error("Error fetching goals:", goalError);
                else state.savingsGoals = goals;

                const { data: expenses, error: expError } = await db.from('expenses').select('*, budget_categories(name), accounts(account_name)');
                if (expError) {
                    console.error("Error fetching expenses:", expError);
                } else {
                    state.expenses = expenses.map(e => ({
                        id: e.id,
                        amount: e.amount,
                        date: e.expense_date,
                        notes: e.notes,
                        category: e.budget_categories ? e.budget_categories.name : 'Uncategorized',
                        sourceAccount: e.accounts.account_name === 'Main Account' ? 'main' : 'savings'
                    }));
                }
                
                // Fetch Income Data
                const { data: sources, error: sourceError } = await db.from('income_sources').select('*');
                if (sourceError) console.error("Error fetching income sources:", sourceError);
                else state.incomeSources = sources;

                const { data: income, error: incomeError } = await db.from('income').select('*, income_sources(name), accounts(account_name)');
                if (incomeError) {
                    console.error("Error fetching income:", incomeError);
                } else {
                    state.income = income.map(i => ({
                        id: i.id,
                        amount: i.amount,
                        date: i.income_date,
                        notes: i.notes,
                        source: i.income_sources ? i.income_sources.name : 'Uncategorized',
                        depositAccount: i.accounts.account_name === 'Main Account' ? 'main' : 'savings'
                    }));
                }
                
                renderAllBalances();
                initializeOverviewCharts();
                renderTransactions();
                renderBudgetsPage();
                renderIncomePage();
                loadTheme();
                loadSidebarState();
            }


            // --- PAGE NAVIGATION ---
            const navLinks = document.querySelectorAll('.nav-link');
            const pages = document.querySelectorAll('.page-content');
            
            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = this.dataset.page;
                    navLinks.forEach(l => {
                        l.classList.remove('bg-gray-700', 'text-white');
                        l.classList.add('hover:bg-gray-700');
                    });
                    this.classList.add('bg-gray-700', 'text-white');
                    this.classList.remove('hover:bg-gray-700');
                    
                    pages.forEach(p => p.classList.add('hidden'));
                    document.getElementById(`${page}-page`).classList.remove('hidden');

                    if (page === 'overview') {
                        initializeOverviewCharts();
                    } else if (page === 'expenses') {
                        renderExpensesPage();
                    } else if (page === 'budgets') {
                        renderBudgetsPage();
                    } else if (page === 'income') {
                        renderIncomePage();
                    } else if (page === 'reports') {
                        renderReportsPage();
                    }
                });
            });

            // --- MODAL HANDLING ---
            const modals = document.querySelectorAll('.fixed.inset-0');
            const showModal = (modalId) => document.getElementById(modalId).classList.remove('hidden');
            const hideModal = (modal) => {
                modal.querySelector('.modal-enter').classList.replace('modal-enter', 'modal-leave');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modal.querySelector('.modal-leave').classList.replace('modal-leave', 'modal-enter');
                }, 300);
            };
            
            const populateCategoryDropdown = () => {
                const select = document.getElementById('bill-category');
                select.innerHTML = '<option value="">Select a category</option>';
                state.budgetCategories.forEach(cat => {
                    select.innerHTML += `<option value="${cat.name}">${cat.name}</option>`;
                });
            };

            document.getElementById('add-category-btn').addEventListener('click', () => showModal('add-category-modal'));
            document.getElementById('add-bill-btn').addEventListener('click', () => {
                populateCategoryDropdown();
                showModal('add-bill-modal');
            });
            document.getElementById('add-goal-btn').addEventListener('click', () => showModal('add-goal-modal'));
            document.getElementById('manage-sources-btn').addEventListener('click', () => {
                renderIncomeSourcesList();
                showModal('manage-sources-modal');
            });

            modals.forEach(modal => {
                modal.addEventListener('click', e => {
                    if (e.target === modal || e.target.closest('.modal-close-btn')) {
                        hideModal(modal);
                    }
                });
            });

            // --- ACCOUNT BALANCE LOGIC ---
            const accountMenuBtns = document.querySelectorAll('.account-menu-btn');
            const updateAccountBtns = document.querySelectorAll('.update-account-btn');
            const updateAccountBalanceForm = document.getElementById('update-account-balance-form');
            const updateAccountModalTitle = document.getElementById('update-account-modal-title');
            
            accountMenuBtns.forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const currentDropdown = document.querySelector(`[data-dropdown='${btn.dataset.account}']`);
                    const isHidden = currentDropdown.classList.contains('hidden');
                    document.querySelectorAll('.account-dropdown').forEach(d => d.classList.add('hidden'));
                    if (isHidden) {
                        currentDropdown.classList.remove('hidden');
                    }
                });
            });

            updateAccountBtns.forEach(btn => {
                btn.addEventListener('click', () => {
                    const account = btn.dataset.account;
                    btn.closest('.account-dropdown').classList.add('hidden');
                    let title = "Update Balance";
                    if (account === 'total') title = 'Update Total Balance';
                    if (account === 'main') title = 'Update Main Account Balance';
                    if (account === 'savings') title = 'Update Savings Balance';
                    updateAccountModalTitle.textContent = title;
                    updateAccountBalanceForm.dataset.accountToUpdate = account;
                    showModal('update-account-balance-modal');
                });
            });
            
             updateAccountBalanceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const accountNameToUpdate = e.target.dataset.accountToUpdate === 'main' ? 'Main Account' : 'Savings';
                const newBalanceInput = document.getElementById('new-account-balance');
                const newBalance = parseFloat(newBalanceInput.value);

                if (!isNaN(newBalance)) {
                    const account = state.accounts.find(a => a.account_name === accountNameToUpdate);
                    if (account) {
                        const { error } = await db.from('accounts').update({ balance: newBalance }).eq('id', account.id);
                        if(error) {
                            console.error("Error updating account balance:", error);
                        } else {
                            account.balance = newBalance;
                            renderAllBalances();
                            updateBalanceChart(state.totalBalance);
                        }
                    }
                    
                    hideModal(document.getElementById('update-account-balance-modal'));
                    newBalanceInput.value = '';
                }
            });

            // --- BUDGETS PAGE LOGIC ---
            const budgetList = document.getElementById('budget-categories-list');
            const addCategoryForm = document.getElementById('add-category-form');
            const editCategoryForm = document.getElementById('edit-category-form');
            const billsList = document.getElementById('recurring-bills-list');
            const addBillForm = document.getElementById('add-bill-form');
            const goalsList = document.getElementById('savings-goals-list');
            const addGoalForm = document.getElementById('add-goal-form');

            const renderBudgetsPage = () => {
                renderBudgetCategories();
                renderRecurringBills();
                renderSavingsGoals();
            };
            const renderBudgetCategories = () => {
                 let content = '';
                if (state.budgetCategories.length === 0) {
                    content = '<p class="text-sm text-gray-500 dark:text-gray-400">No budget categories added yet.</p>';
                } else {
                    state.budgetCategories.forEach(cat => {
                        const spent = state.expenses
                            .filter(e => e.category === cat.name)
                            .reduce((sum, e) => sum + e.amount, 0);

                        const percentage = cat.limit > 0 ? Math.min((spent / cat.limit) * 100, 100) : 0;
                        let progressBarColor = 'bg-green-500';
                        if (percentage > 90) progressBarColor = 'bg-red-500';
                        else if (percentage > 70) progressBarColor = 'bg-yellow-500';

                        content += `
                            <div class="flex items-center space-x-4">
                                <div class="flex-1">
                                    <div class="flex justify-between items-center mb-1 text-sm">
                                        <span class="font-medium text-gray-900 dark:text-white">${cat.name}</span>
                                        <span class="text-gray-500 dark:text-gray-400">
                                            <span class="font-semibold text-gray-800 dark:text-gray-200">${formatCurrency(spent)}</span> / ${formatCurrency(cat.limit)}
                                        </span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                        <div class="${progressBarColor} h-2.5 rounded-full" style="width: ${percentage}%"></div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button data-id="${cat.id}" class="edit-category-btn text-gray-400 hover:text-blue-500 transition-colors">
                                        <i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i>
                                    </button>
                                    <button data-id="${cat.id}" class="delete-category-btn text-gray-400 hover:text-red-500 transition-colors">
                                        <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                                    </button>
                                </div>
                            </div>
                        `;
                    });
                }
                budgetList.innerHTML = content;
                lucide.createIcons();
            };
            addCategoryForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('category-name').value;
                const limit = parseFloat(document.getElementById('category-limit').value);
                
                if (name && limit) {
                    const { data: newCategory, error } = await db.from('budget_categories').insert({
                        name: name,
                        limit: limit
                    }).select().single();

                    if (error) {
                        console.error('Error adding category:', error);
                        return;
                    }

                    state.budgetCategories.push(newCategory);
                    renderBudgetsPage();
                    addCategoryForm.reset();
                    hideModal(document.getElementById('add-category-modal'));
                }
            });

            budgetList.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-category-btn');
                const editBtn = e.target.closest('.edit-category-btn');

                if (deleteBtn) {
                    const categoryId = parseInt(deleteBtn.dataset.id);
                    const { error } = await db.from('budget_categories').delete().eq('id', categoryId);

                    if (error) {
                        if (error.code === '23503') { 
                            alert('Cannot delete this category because it has associated expenses or bills. Please reassign or delete them first.');
                        } else {
                           console.error('Error deleting category:', error);
                        }
                        return;
                    }
                    
                    state.budgetCategories = state.budgetCategories.filter(cat => cat.id !== categoryId);
                    renderBudgetsPage();
                }

                if (editBtn) {
                    const categoryId = parseInt(editBtn.dataset.id);
                    const category = state.budgetCategories.find(cat => cat.id === categoryId);
                    if (category) {
                        document.getElementById('edit-category-id').value = category.id;
                        document.getElementById('edit-category-name').value = category.name;
                        document.getElementById('edit-category-limit').value = category.limit;
                        showModal('edit-category-modal');
                    }
                }
            });

            editCategoryForm.addEventListener('submit', async(e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('edit-category-id').value);
                const name = document.getElementById('edit-category-name').value;
                const limit = parseFloat(document.getElementById('edit-category-limit').value);

                if (id && name && limit) {
                    const { error } = await db.from('budget_categories').update({ name, limit }).eq('id', id);
                    if (error) {
                        console.error('Error updating category:', error);
                        return;
                    }

                    const categoryInState = state.budgetCategories.find(c => c.id === id);
                    categoryInState.name = name;
                    categoryInState.limit = limit;

                    renderBudgetsPage();
                    populateExpenseCategoryDropdowns();
                    editCategoryForm.reset();
                    hideModal(document.getElementById('edit-category-modal'));
                }
            });
            const renderRecurringBills = () => {
                 let content = '';
                if (state.recurringBills.length === 0) {
                    content = '<p class="text-sm text-gray-500 dark:text-gray-400">No recurring bills added yet.</p>';
                } else {
                    state.recurringBills.forEach(bill => {
                        content += `
                            <div class="flex justify-between items-center p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                <div class="flex-1">
                                    <p class="font-medium text-gray-900 dark:text-white">${bill.name}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${bill.category}</p>
                                </div>
                                <span class="font-semibold mr-4 text-gray-900 dark:text-white">${formatCurrency(bill.amount)}</span>
                                 <button data-id="${bill.id}" class="delete-bill-btn text-gray-400 hover:text-red-500 transition-colors">
                                    <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                            </div>
                        `;
                    });
                }
                billsList.innerHTML = content;
                lucide.createIcons();
            };
             addBillForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('bill-name').value;
                const amount = parseFloat(document.getElementById('bill-amount').value);
                const categoryName = document.getElementById('bill-category').value;
                
                if (name && amount && categoryName) {
                    const category = state.budgetCategories.find(c => c.name === categoryName);
                    if (!category) {
                        console.error("Category not found");
                        return;
                    }

                    const { data: newBill, error } = await db.from('recurring_bills').insert({
                        name: name,
                        amount: amount,
                        category_id: category.id
                    }).select('*, budget_categories(name)').single();
                    
                    if (error) {
                        console.error('Error adding bill:', error);
                        return;
                    }

                    state.recurringBills.push({
                        id: newBill.id,
                        name: newBill.name,
                        amount: newBill.amount,
                        category: newBill.budget_categories.name
                    });

                    renderRecurringBills();
                    addBillForm.reset();
                    hideModal(document.getElementById('add-bill-modal'));
                }
            });

            billsList.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-bill-btn');
                if (deleteBtn) {
                    const billId = parseInt(deleteBtn.dataset.id);
                    const { error } = await db.from('recurring_bills').delete().eq('id', billId);
                    if (error) {
                        console.error('Error deleting bill:', error);
                        return;
                    }
                    state.recurringBills = state.recurringBills.filter(bill => bill.id !== billId);
                    renderRecurringBills();
                }
            });
            const renderSavingsGoals = () => {
                let content = '';
                 if (state.savingsGoals.length === 0) {
                    content = '<p class="text-sm text-gray-500 dark:text-gray-400">No savings goals added yet.</p>';
                } else {
                    state.savingsGoals.forEach(goal => {
                        const percentage = goal.target_amount > 0 ? Math.min((goal.saved_amount / goal.target_amount) * 100, 100) : 0;
                        content += `
                            <div class="flex items-center space-x-4">
                                <div class="flex-1">
                                    <div class="flex justify-between items-center mb-1 text-sm font-medium text-gray-900 dark:text-white">
                                        <span>${goal.name}</span>
                                        <span>${Math.round(percentage)}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                                        <div class="bg-indigo-500 h-2.5 rounded-full" style="width: ${percentage}%"></div>
                                    </div>
                                    <div class="text-right text-xs text-gray-500 dark:text-gray-400 mt-1">
                                        ${formatCurrency(goal.saved_amount)} / ${formatCurrency(goal.target_amount)}
                                    </div>
                                </div>
                                <button data-id="${goal.id}" class="delete-goal-btn text-gray-400 hover:text-red-500 transition-colors">
                                    <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                                </button>
                            </div>
                        `;
                    });
                }
                goalsList.innerHTML = content;
                lucide.createIcons();
            };
            addGoalForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const name = document.getElementById('goal-name').value;
                const target = parseFloat(document.getElementById('goal-target').value);

                if (name && target) {
                    const { data: newGoal, error } = await db.from('savings_goals').insert({
                        name: name,
                        target_amount: target,
                        saved_amount: 0
                    }).select().single();

                    if (error) {
                        console.error('Error adding savings goal:', error);
                        return;
                    }

                    state.savingsGoals.push(newGoal);
                    renderSavingsGoals();
                    addGoalForm.reset();
                    hideModal(document.getElementById('add-goal-modal'));
                }
            });

            goalsList.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-goal-btn');
                if (deleteBtn) {
                    const goalId = parseInt(deleteBtn.dataset.id);
                    const { error } = await db.from('savings_goals').delete().eq('id', goalId);

                    if (error) {
                        console.error('Error deleting savings goal:', error);
                        return;
                    }

                    state.savingsGoals = state.savingsGoals.filter(goal => goal.id !== goalId);
                    renderSavingsGoals();
                }
            });
            
            // --- EXPENSES PAGE LOGIC ---
            const addExpenseForm = document.getElementById('add-expense-form');
            const expenseHistoryList = document.getElementById('expense-history-list');
            const editExpenseForm = document.getElementById('edit-expense-form');
            const totalSpentMonthEl = document.getElementById('total-spent-month');
            let spendingPieChart;

            const renderExpensesPage = () => {
                populateExpenseCategoryDropdowns();
                renderExpenseHistory();
                renderSpendingSummary();
                document.getElementById('expense-date').valueAsDate = new Date(); // Default to today
            };
            
            const populateExpenseCategoryDropdowns = () => {
                const selects = [
                    document.getElementById('expense-category'), 
                    document.getElementById('expense-category-filter'),
                    document.getElementById('edit-expense-category')
                ];
                selects.forEach(select => {
                    const currentValue = select.value;
                    let options = (select.id === 'expense-category-filter') ? '<option value="all">All Categories</option>' : '<option value="">Select a Category</option>';
                    state.budgetCategories.forEach(cat => {
                        options += `<option value="${cat.name}">${cat.name}</option>`;
                    });
                    select.innerHTML = options;
                    select.value = currentValue;
                });
            };

            const renderExpenseHistory = () => {
                const searchTerm = document.getElementById('expense-search-input').value.toLowerCase();
                const categoryFilter = document.getElementById('expense-category-filter').value;
                const dateFilter = document.getElementById('expense-date-filter').value;

                let filteredExpenses = state.expenses.filter(exp => {
                    const noteMatch = exp.notes ? exp.notes.toLowerCase().includes(searchTerm) : false;
                    const matchesSearch = searchTerm === '' || noteMatch;
                    const matchesCategory = categoryFilter === 'all' || exp.category === categoryFilter;
                    const matchesDate = dateFilter === '' || exp.date === dateFilter;
                    return matchesSearch && matchesCategory && matchesDate;
                });

                filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));

                if (filteredExpenses.length === 0) {
                    expenseHistoryList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No expenses found for the selected criteria.</p>';
                    return;
                }

                expenseHistoryList.innerHTML = filteredExpenses.map(exp => `
                    <div class="grid grid-cols-10 gap-2 items-center p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50 text-sm">
                        <span class="col-span-2 text-gray-600 dark:text-gray-400">${new Date(exp.date).toLocaleDateString('en-GB')}</span>
                        <span class="col-span-3 font-medium truncate" title="${exp.notes}">${exp.notes || 'N/A'}</span>
                        <span class="col-span-2 text-gray-500 dark:text-gray-400">${exp.category}</span>
                        <span class="col-span-2 font-semibold text-right">${formatCurrency(exp.amount)}</span>
                        <div class="col-span-1 flex justify-end space-x-2">
                            <button data-id="${exp.id}" class="edit-expense-btn text-gray-400 hover:text-blue-500"><i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i></button>
                            <button data-id="${exp.id}" class="delete-expense-btn text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            };
            const renderSpendingSummary = () => {
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();

                const monthlyExpenses = state.expenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    return expDate.getMonth() === currentMonth && expDate.getFullYear() === currentYear;
                });

                const totalSpent = monthlyExpenses.reduce((sum, exp) => sum + exp.amount, 0);
                totalSpentMonthEl.textContent = formatCurrency(totalSpent);
                
                const spendingByCategory = monthlyExpenses.reduce((acc, exp) => {
                    acc[exp.category] = (acc[exp.category] || 0) + exp.amount;
                    return acc;
                }, {});

                const chartLabels = Object.keys(spendingByCategory);
                const chartData = Object.values(spendingByCategory);
                
                const pieCtx = document.getElementById('spending-pie-chart').getContext('2d');
                if (spendingPieChart) {
                    spendingPieChart.destroy();
                }
                spendingPieChart = new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: chartLabels,
                        datasets: [{ data: chartData, backgroundColor: ['#2DD4BF', '#818CF8', '#FBBF24', '#38BDF8', '#F87171', '#A78BFA'], borderWidth: 0 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            };

            addExpenseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const amount = parseFloat(document.getElementById('expense-amount').value);
                const date = document.getElementById('expense-date').value;
                const categoryName = document.getElementById('expense-category').value;
                const sourceAccountName = document.getElementById('expense-source').value === 'main' ? 'Main Account' : 'Savings';
                const notes = document.getElementById('expense-notes').value;
                
                if (amount && date && categoryName && sourceAccountName) {
                    const category = state.budgetCategories.find(c => c.name === categoryName);
                    const account = state.accounts.find(a => a.account_name === sourceAccountName);

                    if (!category || !account) {
                        console.error("Category or Account not found in state");
                        return;
                    }

                    // 1. Insert into DB
                    const { data: newExpense, error: insertError } = await db.from('expenses').insert({
                        amount,
                        expense_date: date,
                        category_id: category.id,
                        account_id: account.id,
                        notes
                    }).select('*, budget_categories(name), accounts(account_name)').single();

                    if(insertError) {
                        console.error("Error inserting expense:", insertError);
                        return;
                    }

                    // 2. Update account balance in DB
                    const newBalance = parseFloat(account.balance) - amount;
                    const { error: updateError } = await db.from('accounts').update({ balance: newBalance }).eq('id', account.id);

                    if(updateError){
                         console.error("Error updating balance:", updateError);
                         // TODO: Maybe delete the inserted expense here for consistency
                         return;
                    }

                    // 3. Update local state
                    state.expenses.push({
                        id: newExpense.id,
                        amount: newExpense.amount,
                        date: newExpense.expense_date,
                        notes: newExpense.notes,
                        category: newExpense.budget_categories.name,
                        sourceAccount: newExpense.accounts.account_name === 'Main Account' ? 'main' : 'savings'
                    });
                    account.balance = newBalance;

                    // 4. Re-render UI
                    renderAllBalances();
                    updateBalanceChart(state.totalBalance);
                    renderExpenseHistory();
                    renderSpendingSummary();
                    renderTransactions();
                    renderBudgetsPage(); // To update spent amounts
                    addExpenseForm.reset();
                    document.getElementById('expense-date').valueAsDate = new Date();
                }
            });
            
            document.getElementById('expense-search-input').addEventListener('input', renderExpenseHistory);
            document.getElementById('expense-category-filter').addEventListener('change', renderExpenseHistory);
            document.getElementById('expense-date-filter').addEventListener('change', renderExpenseHistory);
            
            expenseHistoryList.addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-expense-btn');
                if (editBtn) {
                    const expenseId = parseInt(editBtn.dataset.id);
                    const expenseToEdit = state.expenses.find(exp => exp.id === expenseId);
                    if (expenseToEdit) {
                        document.getElementById('edit-expense-id').value = expenseToEdit.id;
                        document.getElementById('edit-expense-amount').value = expenseToEdit.amount;
                        document.getElementById('edit-expense-date').value = expenseToEdit.date;
                        document.getElementById('edit-expense-category').value = expenseToEdit.category;
                        document.getElementById('edit-expense-source').value = expenseToEdit.sourceAccount;
                        document.getElementById('edit-expense-notes').value = expenseToEdit.notes;
                        showModal('edit-expense-modal');
                    }
                }
            });

            editExpenseForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('edit-expense-id').value);
                const originalExpense = state.expenses.find(exp => exp.id === id);

                const newAmount = parseFloat(document.getElementById('edit-expense-amount').value);
                const newDate = document.getElementById('edit-expense-date').value;
                const newCategoryName = document.getElementById('edit-expense-category').value;
                const newSource = document.getElementById('edit-expense-source').value;
                const newNotes = document.getElementById('edit-expense-notes').value;
                
                const newCategory = state.budgetCategories.find(c => c.name === newCategoryName);
                if (!newCategory) return;
                
                // 1. Revert old transaction from accounts
                const originalAccount = state.accounts.find(a => a.account_name.toLowerCase().startsWith(originalExpense.sourceAccount));
                originalAccount.balance += originalExpense.amount;
                
                // 2. Apply new transaction to accounts
                const newAccount = state.accounts.find(a => a.account_name.toLowerCase().startsWith(newSource));
                newAccount.balance -= newAmount;
                
                // 3. Update database
                await db.from('expenses').update({
                    amount: newAmount,
                    expense_date: newDate,
                    category_id: newCategory.id,
                    account_id: newAccount.id,
                    notes: newNotes
                }).eq('id', id);

                await db.from('accounts').update({ balance: originalAccount.balance }).eq('id', originalAccount.id);
                if (originalAccount.id !== newAccount.id) {
                    await db.from('accounts').update({ balance: newAccount.balance }).eq('id', newAccount.id);
                }

                // 4. Update state & re-render
                const index = state.expenses.findIndex(exp => exp.id === id);
                state.expenses[index] = { ...originalExpense, amount: newAmount, date: newDate, category: newCategoryName, sourceAccount: newSource, notes: newNotes };
                
                await loadInitialData(); // Easiest way to ensure all states are in sync
                hideModal(document.getElementById('edit-expense-modal'));
            });

            // --- INCOME PAGE LOGIC ---
            const addIncomeForm = document.getElementById('add-income-form');
            const incomeHistoryList = document.getElementById('income-history-list');
            const editIncomeForm = document.getElementById('edit-income-form');
            const totalIncomeMonthEl = document.getElementById('total-income-month');
            const addSourceForm = document.getElementById('add-source-form');
            const incomeSourcesList = document.getElementById('income-sources-list');
            let incomePieChart;

            const renderIncomePage = () => {
                populateIncomeSourceDropdowns();
                renderIncomeHistory();
                renderIncomeSummary();
                document.getElementById('income-date').valueAsDate = new Date();
            };

            const populateIncomeSourceDropdowns = () => {
                const selects = [
                    document.getElementById('income-source'),
                    document.getElementById('edit-income-source')
                ];
                selects.forEach(select => {
                    let options = '<option value="">Select a Source</option>';
                    state.incomeSources.forEach(source => {
                        options += `<option value="${source.name}">${source.name}</option>`;
                    });
                    select.innerHTML = options;
                });
            };

            const renderIncomeHistory = () => {
                let content = '';
                const sortedIncome = [...state.income].sort((a, b) => new Date(b.date) - new Date(a.date));

                if (sortedIncome.length === 0) {
                    incomeHistoryList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No income recorded yet.</p>';
                    return;
                }
                
                sortedIncome.forEach(inc => {
                    content += `
                        <div class="grid grid-cols-12 gap-2 items-center p-2 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-700/50 text-sm">
                            <span class="col-span-2 text-gray-600 dark:text-gray-400">${new Date(inc.date).toLocaleDateString('en-GB')}</span>
                            <span class="col-span-3 font-medium text-green-700 dark:text-green-400">${inc.source}</span>
                            <span class="col-span-3 text-gray-500 dark:text-gray-400 truncate" title="${inc.notes}">${inc.notes || 'N/A'}</span>
                            <span class="col-span-2 font-semibold text-right text-green-600 dark:text-green-500">${formatCurrency(inc.amount)}</span>
                             <div class="col-span-2 flex justify-end space-x-2">
                                <button data-id="${inc.id}" class="edit-income-btn text-gray-400 hover:text-blue-500"><i data-lucide="edit" class="w-4 h-4 pointer-events-none"></i></button>
                                <button data-id="${inc.id}" class="delete-income-btn text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i></button>
                            </div>
                        </div>`;
                });
                incomeHistoryList.innerHTML = content;
                lucide.createIcons();
            };

            const renderIncomeSummary = () => {
                totalIncomeMonthEl.textContent = formatCurrency(state.totalIncomeThisMonth);

                const incomeBySource = state.income.reduce((acc, inc) => {
                    acc[inc.source] = (acc[inc.source] || 0) + inc.amount;
                    return acc;
                }, {});

                const chartLabels = Object.keys(incomeBySource);
                const chartData = Object.values(incomeBySource);

                const pieCtx = document.getElementById('income-pie-chart').getContext('2d');
                if (incomePieChart) {
                    incomePieChart.destroy();
                }
                incomePieChart = new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: chartLabels,
                        datasets: [{ data: chartData, backgroundColor: ['#22C55E', '#84CC16', '#FACC15', '#38BDF8', '#A78BFA'], borderWidth: 0 }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
                });
            };

            addIncomeForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const amount = parseFloat(document.getElementById('income-amount').value);
                const date = document.getElementById('income-date').value;
                const sourceName = document.getElementById('income-source').value;
                const depositAccountName = document.getElementById('income-account').value === 'main' ? 'Main Account' : 'Savings';
                const notes = document.getElementById('income-notes').value;

                if (amount && date && sourceName && depositAccountName) {
                    const source = state.incomeSources.find(s => s.name === sourceName);
                    const account = state.accounts.find(a => a.account_name === depositAccountName);

                    if (!source || !account) {
                        console.error("Source or Account not found in state");
                        return;
                    }

                    const { data: newIncome, error: insertError } = await db.from('income').insert({
                        amount,
                        income_date: date,
                        source_id: source.id,
                        account_id: account.id,
                        notes
                    }).select('*, income_sources(name), accounts(account_name)').single();

                    if (insertError) {
                        console.error("Error inserting income:", insertError);
                        return;
                    }

                    const newBalance = parseFloat(account.balance) + amount;
                    const { error: updateError } = await db.from('accounts').update({ balance: newBalance }).eq('id', account.id);

                    if (updateError) {
                        console.error("Error updating balance after income:", updateError);
                        return;
                    }

                    state.income.push({
                        id: newIncome.id,
                        amount: newIncome.amount,
                        date: newIncome.income_date,
                        notes: newIncome.notes,
                        source: newIncome.income_sources.name,
                        depositAccount: newIncome.accounts.account_name === 'Main Account' ? 'main' : 'savings'
                    });
                    account.balance = newBalance;

                    renderAllBalances();
                    updateBalanceChart(state.totalBalance);
                    renderIncomePage();
                    addIncomeForm.reset();
                    document.getElementById('income-date').valueAsDate = new Date();
                }
            });
            
            incomeHistoryList.addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-income-btn');
                const deleteBtn = e.target.closest('.delete-income-btn');

                if (editBtn) {
                    const incomeId = parseInt(editBtn.dataset.id);
                    const incomeToEdit = state.income.find(inc => inc.id === incomeId);
                    if (incomeToEdit) {
                        document.getElementById('edit-income-id').value = incomeToEdit.id;
                        document.getElementById('edit-income-amount').value = incomeToEdit.amount;
                        document.getElementById('edit-income-date').value = incomeToEdit.date;
                        document.getElementById('edit-income-source').value = incomeToEdit.source;
                        document.getElementById('edit-income-account').value = incomeToEdit.depositAccount;
                        document.getElementById('edit-income-notes').value = incomeToEdit.notes;
                        showModal('edit-income-modal');
                    }
                }

                if (deleteBtn) {
                    const incomeId = parseInt(deleteBtn.dataset.id);
                    const incomeToDelete = state.income.find(inc => inc.id === incomeId);
                    if (incomeToDelete) {
                        const account = state.accounts.find(a => a.account_name.toLowerCase().startsWith(incomeToDelete.depositAccount));
                        
                        const newBalance = account.balance - incomeToDelete.amount;
                        
                        const { error: updateError } = await db.from('accounts').update({ balance: newBalance }).eq('id', account.id);
                        if (updateError) {
                            console.error("Error updating account balance on delete:", updateError);
                            return;
                        }

                        const { error: deleteError } = await db.from('income').delete().eq('id', incomeId);
                        if (deleteError) {
                            console.error("Error deleting income:", deleteError);
                            // Revert balance change if delete fails
                            await db.from('accounts').update({ balance: account.balance }).eq('id', account.id);
                            return;
                        }

                        // Update state
                        account.balance = newBalance;
                        state.income = state.income.filter(inc => inc.id !== incomeId);

                        // Re-render
                        renderAllBalances();
                        renderIncomePage();
                        renderTransactions();
                        updateBalanceChart(state.totalBalance);
                    }
                }
            });

            editIncomeForm.addEventListener('submit', async(e) => {
                e.preventDefault();
                const id = parseInt(document.getElementById('edit-income-id').value);
                const originalIncome = state.income.find(inc => inc.id === id);

                const newAmount = parseFloat(document.getElementById('edit-income-amount').value);
                const newDate = document.getElementById('edit-income-date').value;
                const newSourceName = document.getElementById('edit-income-source').value;
                const newAccountName = document.getElementById('edit-income-account').value;
                const newNotes = document.getElementById('edit-income-notes').value;
                
                const newSource = state.incomeSources.find(s => s.name === newSourceName);
                if (!newSource) return;

                const originalAccount = state.accounts.find(a => a.account_name.toLowerCase().startsWith(originalIncome.depositAccount));
                const newAccount = state.accounts.find(a => a.account_name.toLowerCase().startsWith(newAccountName));
                
                // Revert old transaction
                originalAccount.balance -= originalIncome.amount;

                // Apply new transaction
                newAccount.balance += newAmount;

                // DB Updates
                await db.from('income').update({
                    amount: newAmount,
                    income_date: newDate,
                    source_id: newSource.id,
                    account_id: newAccount.id,
                    notes: newNotes
                }).eq('id', id);

                await db.from('accounts').update({ balance: originalAccount.balance }).eq('id', originalAccount.id);
                if (originalAccount.id !== newAccount.id) {
                    await db.from('accounts').update({ balance: newAccount.balance }).eq('id', newAccount.id);
                }

                // Easiest to just reload all data to ensure consistency
                await loadInitialData();
                hideModal(document.getElementById('edit-income-modal'));
            });

            const renderIncomeSourcesList = () => {
                incomeSourcesList.innerHTML = state.incomeSources.map(source => `
                    <div class="flex justify-between items-center p-2 rounded-lg bg-gray-50 dark:bg-gray-700/50">
                        <span class="text-gray-900 dark:text-white">${source.name}</span>
                        <button data-id="${source.id}" class="delete-source-btn text-gray-400 hover:text-red-500">
                            <i data-lucide="trash-2" class="w-4 h-4 pointer-events-none"></i>
                        </button>
                    </div>
                `).join('');
                lucide.createIcons();
            };

            addSourceForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const nameInput = document.getElementById('new-source-name');
                const name = nameInput.value.trim();
                if (name) {
                    const { data: newSource, error } = await db.from('income_sources').insert({ name }).select().single();
                    if (error) {
                        console.error('Error adding source:', error);
                        alert('Failed to add new source. Check console for details.');
                        return;
                    }
                    state.incomeSources.push(newSource);
                    renderIncomeSourcesList();
                    populateIncomeSourceDropdowns();
                    nameInput.value = '';
                }
            });

            incomeSourcesList.addEventListener('click', async (e) => {
                const deleteBtn = e.target.closest('.delete-source-btn');
                if (deleteBtn) {
                    const sourceId = parseInt(deleteBtn.dataset.id);
                    const { error } = await db.from('income_sources').delete().eq('id', sourceId);
                    if (error) {
                         alert('Cannot delete this source as it is linked to existing income records.');
                         console.error('Error deleting source:', error);
                         return;
                    }
                    state.incomeSources = state.incomeSources.filter(s => s.id !== sourceId);
                    renderIncomeSourcesList();
                    populateIncomeSourceDropdowns();
                }
            });

            // --- OVERVIEW PAGE LOGIC ---
            let accountBalanceChart;
            const transactionsList = document.getElementById('transactions-list');
            const seeAllBtn = document.getElementById('see-all-transactions');
            let transactionsVisible = 3;

            const updateBalanceChart = (newTotal) => {
                if (accountBalanceChart) {
                    const data = accountBalanceChart.data.datasets[0].data;
                    data[data.length - 1] = newTotal;
                    accountBalanceChart.update();
                }
            };

            const initializeOverviewCharts = () => {
                if (accountBalanceChart) {
                    accountBalanceChart.destroy();
                }
                
                const chartData = generateDynamicChartData();

                const balanceCtx = document.getElementById('accountBalanceChart').getContext('2d');
                const gradient = balanceCtx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(74, 222, 128, 0.3)');
                gradient.addColorStop(1, 'rgba(74, 222, 128, 0)');

                accountBalanceChart = new Chart(balanceCtx, {
                    type: 'line', 
                    data: { labels: chartData.year.labels, datasets: [{ data: chartData.year.data, borderColor: '#2DD4BF', backgroundColor: gradient, fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 6, pointHoverBackgroundColor: '#fff', pointHoverBorderColor: '#2DD4BF' }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: { y: { beginAtZero: true, ticks: { callback: (value) => '₹' + (value / 1000) + 'k', color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280' } }, x: { grid: { display: false }, ticks: { color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280'} } },
                        plugins: { 
                            legend: { display: false }, 
                            tooltip: { 
                                enabled: false, 
                                external: function(context) { 
                                    let tooltipEl = document.getElementById('chartjs-tooltip'); 
                                    if (!tooltipEl) { 
                                        tooltipEl = document.createElement('div'); 
                                        tooltipEl.id = 'chartjs-tooltip'; 
                                        document.body.appendChild(tooltipEl); 
                                    } 
                                    const tooltipModel = context.tooltip; 
                                    if (tooltipModel.opacity === 0) { 
                                        tooltipEl.style.opacity = 0; 
                                        return; 
                                    } 
                                    if (tooltipModel.body) { 
                                        const dataPoints = tooltipModel.dataPoints; 
                                        if (dataPoints.length > 0) { 
                                            const date = dataPoints[0].label; 
                                            const value = formatCurrency(dataPoints[0].raw); 
                                            tooltipEl.innerHTML = `<div class="text-center p-2 bg-gray-800 text-white rounded-lg shadow-lg"><div class="text-xs text-gray-400">${date}</div><div class="text-base font-bold">${value}</div></div>`; 
                                        } 
                                    } 
                                    const { offsetLeft: canvasLeft, offsetTop: canvasTop } = context.chart.canvas; 
                                    tooltipEl.style.opacity = 1; 
                                    tooltipEl.style.position = 'absolute'; 
                                    tooltipEl.style.left = canvasLeft + tooltipModel.caretX - (tooltipEl.offsetWidth / 2) + 'px'; 
                                    tooltipEl.style.top = canvasTop + tooltipModel.caretY - tooltipEl.offsetHeight - 10 + 'px'; 
                                    tooltipEl.style.pointerEvents = 'none';
                                } 
                            } 
                        }
                    }
                });

                const filterButtons = document.querySelectorAll('.chart-filter-btn');
                filterButtons.forEach(button => {
                     button.addEventListener('click', function() {
                        filterButtons.forEach(btn => btn.classList.remove('active', 'bg-white', 'dark:bg-gray-500', 'text-gray-800', 'dark:text-white'));
                        this.classList.add('active', 'bg-white', 'dark:bg-gray-500', 'text-gray-800', 'dark:text-white');
                        const period = this.dataset.period;
                        accountBalanceChart.data.labels = chartData[period].labels;
                        accountBalanceChart.data.datasets[0].data = chartData[period].data;
                        accountBalanceChart.update();
                    });
                });
            }
            
            const renderTransactions = () => { 
                const formattedExpenses = state.expenses.map(exp => ({
                    type: 'expense',
                    date: exp.date,
                    description: exp.notes || exp.category || "Expense",
                    amount: -exp.amount
                }));

                const formattedIncome = state.income.map(inc => ({
                    type: 'income',
                    date: inc.date,
                    description: inc.notes || inc.source || "Income",
                    amount: inc.amount
                }));

                const allTransactions = [...formattedExpenses, ...formattedIncome]
                    .sort((a, b) => new Date(b.date) - new Date(a.date));

                transactionsList.innerHTML = '';
                
                const formatDateForOverview = (dateString) => {
                    const date = new Date(dateString);
                    const today = new Date();
                    const yesterday = new Date();
                    yesterday.setDate(today.getDate() - 1);

                    if (date.toDateString() === today.toDateString()) return 'Today';
                    if (date.toDateString() === yesterday.toDateString()) return 'Yesterday';
                    return date.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' });
                };

                if(allTransactions.length === 0) {
                    transactionsList.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400 text-center py-4">No recent transactions.</p>';
                    seeAllBtn.classList.add('hidden');
                    return;
                }
                
                seeAllBtn.classList.remove('hidden');

                allTransactions.slice(0, transactionsVisible).forEach(tx => {
                    const name = String(tx.description);
                    const avatar = name.charAt(0).toUpperCase();
                    const amountColor = tx.type === 'income' ? 'text-green-600 dark:text-green-400' : 'text-gray-800 dark:text-gray-200';
                    
                    const badgeText = tx.type === 'income' ? 'Income' : 'Expense';
                    const badgeClasses = tx.type === 'income' ? 'bg-green-100 text-green-800 dark:bg-green-900/50 dark:text-green-400' : 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-400';

                    transactionsList.innerHTML += `
                        <div class="grid grid-cols-6 items-center">
                            <div class="col-span-3 flex items-center space-x-4">
                                <div class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-700 flex items-center justify-center font-bold text-gray-600 dark:text-gray-300">${avatar}</div>
                                <span class="font-medium truncate text-gray-900 dark:text-white" title="${name}">${name}</span>
                            </div>
                            <span class="col-span-1 text-gray-500 dark:text-gray-400 text-sm">${formatDateForOverview(tx.date)}</span>
                            <div class="col-span-2 flex justify-end items-center space-x-4">
                                <span class="px-2 py-1 text-xs font-semibold rounded-full ${badgeClasses}">${badgeText}</span>
                                <span class="font-semibold text-right ${amountColor}">${formatCurrency(tx.amount)}</span>
                            </div>
                        </div>
                    `;
                });
                lucide.createIcons();
             };
            seeAllBtn.addEventListener('click', (e) => { 
                e.preventDefault();
                const totalTransactions = state.expenses.length + state.income.length;
                transactionsVisible = (transactionsVisible === 3) ? totalTransactions : 3;
                seeAllBtn.textContent = (transactionsVisible === 3) ? 'See all' : 'Show less';
                renderTransactions();
             });

            // --- REPORTS PAGE LOGIC ---
            let spendingByCategoryChart, incomeVsExpenseChart, totalSpendingTrendChart, categorySpendingTrendChart;

            const renderReportsPage = () => {
                renderSpendingByCategoryReport();
                renderIncomeVsExpenseReport();
                renderTrendReports();
                
                // Add event listeners once
                document.getElementById('spending-category-date-filter').addEventListener('change', renderSpendingByCategoryReport);
                document.getElementById('category-trend-filter').addEventListener('change', renderCategorySpendingTrend);
            };

            const renderSpendingByCategoryReport = () => {
                const filter = document.getElementById('spending-category-date-filter').value;
                const now = new Date();
                let startDate = new Date();
                
                if (filter === 'this-month') {
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                } else if (filter === 'last-month') {
                    startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
                    now.setDate(0); // End of last month
                } else if (filter === 'this-year') {
                    startDate = new Date(now.getFullYear(), 0, 1);
                }

                const filteredExpenses = state.expenses.filter(exp => {
                    const expDate = new Date(exp.date);
                    return expDate >= startDate && expDate <= now;
                });

                const spendingByCategory = filteredExpenses.reduce((acc, exp) => {
                    acc[exp.category] = (acc[exp.category] || 0) + exp.amount;
                    return acc;
                }, {});

                const chartLabels = Object.keys(spendingByCategory);
                const chartData = Object.values(spendingByCategory);

                const ctx = document.getElementById('spendingByCategoryChart').getContext('2d');
                if (spendingByCategoryChart) spendingByCategoryChart.destroy();
                
                spendingByCategoryChart = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: chartLabels,
                        datasets: [{ data: chartData, backgroundColor: ['#2DD4BF', '#818CF8', '#FBBF24', '#38BDF8', '#F87171', '#A78BFA', '#F472B6', '#6EE7B7'], borderWidth: 0 }]
                    },
                    options: { 
                        responsive: true, 
                        maintainAspectRatio: false, 
                        plugins: { 
                            legend: { position: 'right', labels: { color: document.documentElement.classList.contains('dark') ? '#FFF' : '#333' } },
                        },
                        onClick: (e, elements) => {
                            if (elements.length > 0) {
                                const clickedIndex = elements[0].index;
                                const category = spendingByCategoryChart.data.labels[clickedIndex];
                                displayCategoryTransactions(category, filteredExpenses);
                            }
                        }
                    }
                });
            };
            
            const displayCategoryTransactions = (category, expenses) => {
                const listEl = document.getElementById('category-transaction-list');
                const transactions = expenses.filter(exp => exp.category === category);
                
                if (transactions.length === 0) {
                    listEl.innerHTML = `<p class="text-center text-gray-500 dark:text-gray-400">No transactions for ${category}.</p>`;
                    return;
                }

                listEl.innerHTML = `
                    <h3 class="font-semibold text-lg mb-2 text-gray-900 dark:text-white">${category} Transactions</h3>
                    <div class="space-y-2">
                        ${transactions.map(tx => `
                            <div class="flex justify-between items-center text-sm p-2 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700/50">
                                <div>
                                    <p class="font-medium">${tx.notes || 'Expense'}</p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400">${new Date(tx.date).toLocaleDateString('en-GB')}</p>
                                </div>
                                <span class="font-semibold">${formatCurrency(tx.amount)}</span>
                            </div>
                        `).join('')}
                    </div>
                `;
            };

            const renderIncomeVsExpenseReport = () => {
                const labels = [];
                const incomeData = [];
                const expenseData = [];
                const now = new Date();

                for (let i = 5; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    labels.push(d.toLocaleString('default', { month: 'short' }));

                    const month = d.getMonth();
                    const year = d.getFullYear();

                    const monthlyIncome = state.income.filter(inc => {
                        const incDate = new Date(inc.date);
                        return incDate.getMonth() === month && incDate.getFullYear() === year;
                    }).reduce((sum, inc) => sum + inc.amount, 0);
                    incomeData.push(monthlyIncome);

                    const monthlyExpenses = state.expenses.filter(exp => {
                        const expDate = new Date(exp.date);
                        return expDate.getMonth() === month && expDate.getFullYear() === year;
                    }).reduce((sum, exp) => sum + exp.amount, 0);
                    expenseData.push(monthlyExpenses);
                }
                
                const ctx = document.getElementById('incomeVsExpenseChart').getContext('2d');
                if(incomeVsExpenseChart) incomeVsExpenseChart.destroy();
                incomeVsExpenseChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            { label: 'Income', data: incomeData, backgroundColor: '#22C55E' },
                            { label: 'Expenses', data: expenseData, backgroundColor: '#EF4444' }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                            y: { ticks: { color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280' } },
                            x: { ticks: { color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280' } }
                        },
                        plugins: { legend: { labels: { color: document.documentElement.classList.contains('dark') ? '#FFF' : '#333' } } }
                    }
                });
            };

            const renderTrendReports = () => {
                populateCategoryTrendFilter();
                renderTotalSpendingTrend();
                renderCategorySpendingTrend();
            };

            const renderTotalSpendingTrend = () => {
                const labels = [];
                const spendingData = [];
                const now = new Date();
                
                for(let i = 11; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    labels.push(d.toLocaleString('default', { month: 'short', year: '2-digit' }));
                    
                    const month = d.getMonth();
                    const year = d.getFullYear();

                    const monthlyExpenses = state.expenses
                        .filter(exp => {
                             const expDate = new Date(exp.date);
                             return expDate.getMonth() === month && expDate.getFullYear() === year;
                        })
                        .reduce((sum, exp) => sum + exp.amount, 0);
                    spendingData.push(monthlyExpenses);
                }

                const ctx = document.getElementById('totalSpendingTrendChart').getContext('2d');
                if(totalSpendingTrendChart) totalSpendingTrendChart.destroy();
                totalSpendingTrendChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{ label: 'Total Spending', data: spendingData, borderColor: '#3B82F6', tension: 0.1, fill: false }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                             y: { ticks: { color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280' } },
                             x: { ticks: { color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            };

            const populateCategoryTrendFilter = () => {
                const select = document.getElementById('category-trend-filter');
                select.innerHTML = state.budgetCategories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
            };

            const renderCategorySpendingTrend = () => {
                const selectedCategory = document.getElementById('category-trend-filter').value;
                if (!selectedCategory) return;
                
                const labels = [];
                const spendingData = [];
                const now = new Date();

                for(let i = 11; i >= 0; i--) {
                    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    labels.push(d.toLocaleString('default', { month: 'short', year: '2-digit' }));
                    
                    const month = d.getMonth();
                    const year = d.getFullYear();

                    const monthlyExpenses = state.expenses
                        .filter(exp => {
                             const expDate = new Date(exp.date);
                             return exp.category === selectedCategory && expDate.getMonth() === month && expDate.getFullYear() === year;
                        })
                        .reduce((sum, exp) => sum + exp.amount, 0);
                    spendingData.push(monthlyExpenses);
                }

                const ctx = document.getElementById('categorySpendingTrendChart').getContext('2d');
                if (categorySpendingTrendChart) categorySpendingTrendChart.destroy();
                categorySpendingTrendChart = new Chart(ctx, {
                     type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{ label: selectedCategory, data: spendingData, borderColor: '#8B5CF6', tension: 0.1, fill: false }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        scales: {
                             y: { ticks: { color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280' } },
                             x: { ticks: { color: document.documentElement.classList.contains('dark') ? '#9CA3AF' : '#6B7280' } }
                        },
                        plugins: { legend: { display: false } }
                    }
                });
            };

            // --- SETTINGS PAGE LOGIC ---
            const themeLightBtn = document.getElementById('theme-light-btn');
            const themeDarkBtn = document.getElementById('theme-dark-btn');

            const applyTheme = (theme) => {
                const lightActiveClasses = ['bg-white', 'text-gray-900'];
                const darkActiveClasses = ['bg-gray-900', 'text-white', 'dark:bg-gray-500'];
                
                // Reset both buttons
                themeLightBtn.classList.remove(...lightActiveClasses, ...darkActiveClasses);
                themeDarkBtn.classList.remove(...lightActiveClasses, ...darkActiveClasses);

                if (theme === 'dark') {
                    document.documentElement.classList.add('dark');
                    themeDarkBtn.classList.add(...darkActiveClasses);
                } else {
                    document.documentElement.classList.remove('dark');
                    themeLightBtn.classList.add(...lightActiveClasses);
                }
                
                // Re-initialize charts to update colors for axes and ticks
                if (document.getElementById('overview-page').offsetParent !== null) {
                    initializeOverviewCharts();
                }
                 if (document.getElementById('reports-page').offsetParent !== null) {
                    renderReportsPage();
                }
            };

            const loadTheme = () => {
                const preferredTheme = localStorage.getItem('theme');
                if (preferredTheme) {
                    applyTheme(preferredTheme);
                } else {
                    applyTheme(window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                }
            };
            
            themeLightBtn.addEventListener('click', () => {
                localStorage.setItem('theme', 'light');
                applyTheme('light');
            });
            themeDarkBtn.addEventListener('click', () => {
                localStorage.setItem('theme', 'dark');
                applyTheme('dark');
            });

            // --- SIDEBAR TOGGLE LOGIC ---
            const sidebarToggle = document.getElementById('sidebar-toggle');
            const body = document.body;

            const loadSidebarState = () => {
                if(localStorage.getItem('sidebarCollapsed') === 'true') {
                    body.classList.add('sidebar-collapsed');
                }
            }

            sidebarToggle.addEventListener('click', () => {
                body.classList.toggle('sidebar-collapsed');
                if (body.classList.contains('sidebar-collapsed')) {
                    localStorage.setItem('sidebarCollapsed', 'true');
                } else {
                    localStorage.setItem('sidebarCollapsed', 'false');
                }
            });


            // --- INITIALIZATION ---
            const renderAllBalances = () => {
                totalBalanceAmountEl.textContent = formatCurrency(state.totalBalance);
                mainAccountBalanceEl.textContent = formatCurrency(state.mainAccountBalance);
                savingsBalanceEl.textContent = formatCurrency(state.savingsBalance);
                if (incomeBalanceEl) {
                    incomeBalanceEl.textContent = formatCurrency(state.totalIncomeThisMonth);
                }
            };
            
            const generateDynamicChartData = () => {
                const now = new Date();
                const currentYear = now.getFullYear();
                const currentMonth = now.getMonth();
                const monthLabels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                
                // --- Year Data ---
                let runningBalance = state.totalBalance;
                const yearDataPoints = Array(currentMonth + 1).fill(0);
                for (let i = currentMonth; i >= 0; i--) {
                    yearDataPoints[i] = runningBalance;
                    
                    const monthExpenses = state.expenses
                        .filter(exp => {
                            const d = new Date(exp.date);
                            return d.getFullYear() === currentYear && d.getMonth() === i;
                        })
                        .reduce((sum, exp) => sum + exp.amount, 0);
                    
                    const monthIncome = state.income
                        .filter(inc => {
                             const d = new Date(inc.date);
                            return d.getFullYear() === currentYear && d.getMonth() === i;
                        })
                        .reduce((sum, inc) => sum + inc.amount, 0);

                    runningBalance = runningBalance + monthExpenses - monthIncome;
                }

                // --- Month Data (Last 4 weeks) ---
                const monthDataPoints = [];
                const weekLabels = [];
                let weekRunningBalance = state.totalBalance;
                for (let i = 0; i < 4; i++) {
                    const weekEnd = new Date(now.getTime() - (i * 7 * 24 * 60 * 60 * 1000));
                    const weekStart = new Date(now.getTime() - ((i + 1) * 7 * 24 * 60 * 60 * 1000));
                    monthDataPoints.unshift(weekRunningBalance);
                    weekLabels.unshift(`Week of ${weekStart.toLocaleDateString('en-GB', {day:'2-digit', month:'short'})}`);

                    const weekExpenses = state.expenses
                        .filter(exp => {
                            const expDate = new Date(exp.date);
                            return expDate > weekStart && expDate <= weekEnd;
                        })
                        .reduce((sum, exp) => sum + exp.amount, 0);
                        
                    const weekIncome = state.income
                         .filter(inc => {
                            const incDate = new Date(inc.date);
                            return incDate > weekStart && incDate <= weekEnd;
                        })
                        .reduce((sum, inc) => sum + inc.amount, 0);
                        
                    weekRunningBalance = weekRunningBalance + weekExpenses - weekIncome;
                }
                
                // --- Week Data (Last 7 days) ---
                const weekDataPoints = [];
                const dayLabels = [];
                let dayRunningBalance = state.totalBalance;
                for (let i = 0; i < 7; i++) {
                      const day = new Date(now.getTime() - (i * 24 * 60 * 60 * 1000));
                      weekDataPoints.unshift(dayRunningBalance);
                      dayLabels.unshift(day.toLocaleDateString('en-US', { weekday: 'short' }));
                      
                      const dayExpenses = state.expenses.filter(exp => new Date(exp.date).toDateString() === day.toDateString())
                                                       .reduce((sum, exp) => sum + exp.amount, 0);
                      const dayIncome = state.income.filter(inc => new Date(inc.date).toDateString() === day.toDateString())
                                                       .reduce((sum, inc) => sum + inc.amount, 0);
                                                       
                      dayRunningBalance = dayRunningBalance + dayExpenses - dayIncome;
                }

                return {
                    year: { labels: monthLabels.slice(0, currentMonth + 1), data: yearDataPoints },
                    month: { labels: weekLabels, data: monthDataPoints },
                    week: { labels: dayLabels, data: weekDataPoints },
                    day: { labels: ['Start of Day', 'Current'], data: [dayRunningBalance, state.totalBalance] } // Simplified day view
                };
            };


            await loadInitialData();
        });
    </script>
</body>
</html>

